name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      bot_token:
        description: 'Telegram Bot Token'
        required: true
      admin_chat_id:
        description: 'Admin Chat ID'
        required: true

permissions:
  contents: write  # لرفع الـ artifacts
  actions: write  # للتفاعل مع Actions

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'  # إصدار أحدث للتوافق مع Buildozer

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          unzip openjdk-17-jdk wget libffi-dev libssl-dev zlib1g-dev \
          libncurses5-dev libncursesw5-dev libbz2-dev libreadline-dev \
          libsqlite3-dev lib32stdc++6 lib32z1 autoconf automake libtool

    - name: Set up Java environment
      run: |
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        java -version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython kivy pyjnius telebot

    - name: Install Android SDK
      run: |
        export ANDROID_DIR=$HOME/.buildozer/android/platform
        mkdir -p $ANDROID_DIR/android-sdk/cmdline-tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
        unzip -q /tmp/cmdline-tools.zip -d $ANDROID_DIR/android-sdk/cmdline-tools
        mv $ANDROID_DIR/android-sdk/cmdline-tools/cmdline-tools $ANDROID_DIR/android-sdk/cmdline-tools/latest
        export ANDROID_HOME=$ANDROID_DIR/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        yes | sdkmanager --sdk_root=$ANDROID_HOME \
          "platforms;android-31" "platform-tools" "build-tools;33.0.2"

    - name: Install Android NDK
      run: |
        export ANDROID_DIR=$HOME/.buildozer/android/platform
        mkdir -p $ANDROID_DIR/android-ndk
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O /tmp/ndk.zip
        unzip -q /tmp/ndk.zip -d $ANDROID_DIR/android-ndk
        mv $ANDROID_DIR/android-ndk/android-ndk-r25b $ANDROID_DIR/android-ndk/ndk
        export ANDROID_NDK_HOME=$ANDROID_DIR/android-ndk/ndk
        export PATH=$PATH:$ANDROID_NDK_HOME

    - name: Replace bot token and chat ID
      run: |
        sed -e "s/YOUR_BOT_TOKEN/${{ github.event.inputs.bot_token }}/g" \
            -e "s/YOUR_ADMIN_CHAT_ID/${{ github.event.inputs.admin_chat_id }}/g" \
            client.py > main.py

    - name: Build APK
      run: |
        export ANDROIDSDK=$HOME/.buildozer/android/platform/android-sdk
        export ANDROIDNDK=$HOME/.buildozer/android/platform/android-ndk/ndk
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        buildozer -v android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: mybot-apk
        path: ./bin/*-debug.apk
        retention-days: 7
